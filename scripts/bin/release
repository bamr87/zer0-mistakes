#!/bin/bash

# Simplified release command for zer0-mistakes Jekyll theme
# Usage: ./scripts/release [patch|minor|major] [options]
#
# This replaces the complex gem-publish.sh with a clean, library-based approach.

set -euo pipefail

# Get script and library directories
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

# Source all required libraries
source "$LIB_DIR/common.sh"
source "$LIB_DIR/validation.sh"
source "$LIB_DIR/version.sh"
source "$LIB_DIR/git.sh"
source "$LIB_DIR/changelog.sh"
source "$LIB_DIR/gem.sh"

# Show usage function
show_usage() {
    cat << EOF
ðŸš€ Simplified Release Command for zer0-mistakes

USAGE:
    ./scripts/bin/release [VERSION_TYPE] [OPTIONS]

VERSION TYPES:
    patch       Bump patch version (0.0.X) - Bug fixes (default)
    minor       Bump minor version (0.X.0) - New features
    major       Bump major version (X.0.0) - Breaking changes

OPTIONS:
    --dry-run              Preview changes without executing
    --skip-tests           Skip running test suite
    --skip-publish         Build but don't publish to RubyGems
    --no-github-release    Skip creating GitHub release
    --non-interactive      Run without confirmation prompts
    --verbose              Show detailed debug output
    --help, -h             Show this help message

EXAMPLES:
    ./scripts/bin/release                    # Patch release (0.6.0 â†’ 0.6.1)
    ./scripts/bin/release minor              # Minor release (0.6.0 â†’ 0.7.0)
    ./scripts/bin/release major --dry-run    # Preview major release
    ./scripts/bin/release patch --skip-tests # Quick release without tests

ENVIRONMENT VARIABLES:
    DRY_RUN=true           Enable dry run mode
    INTERACTIVE=false      Disable confirmation prompts
    VERBOSE=true           Enable debug output

WORKFLOW:
    1. Validate environment
    2. Calculate new version
    3. Generate changelog from commits
    4. Update version files
    5. Run tests (unless --skip-tests)
    6. Build gem
    7. Commit and tag
    8. Publish to RubyGems (unless --skip-publish)
    9. Create GitHub release (unless --no-github-release)
    10. Push changes to repository

For more information, see: scripts/lib/README.md
EOF
}

# Default configuration
VERSION_TYPE="patch"
SKIP_TESTS=false
SKIP_PUBLISH=false
SKIP_GITHUB_RELEASE=false
SHOW_HELP=false

# Parse arguments
for arg in "$@"; do
    case $arg in
        --help|-h)
            SHOW_HELP=true
            ;;
        patch|minor|major)
            VERSION_TYPE="$arg"
            ;;
    esac
done

# Show help if requested
if [[ "$SHOW_HELP" == "true" ]]; then
    show_usage
    exit 0
fi

# Parse remaining arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        patch|minor|major)
            # Already handled above
            shift
            ;;
        --help|-h)
            # Already handled above
            shift
            ;;
        --dry-run)
            export DRY_RUN=true
            shift
            ;;
        --skip-tests)
            SKIP_TESTS=true
            shift
            ;;
        --skip-publish)
            SKIP_PUBLISH=true
            shift
            ;;
        --no-github-release)
            SKIP_GITHUB_RELEASE=true
            shift
            ;;
        --non-interactive)
            export INTERACTIVE=false
            shift
            ;;
        --verbose)
            export VERBOSE=true
            shift
            ;;
        *)
            error "Unknown option: $1 (use --help for usage)"
            ;;
    esac
done

# Main release workflow
main() {
    print_header "ðŸš€ Release Automation"
    
    # Show configuration
    info "Version type: $VERSION_TYPE"
    info "Dry run: ${DRY_RUN:-false}"
    info "Interactive: ${INTERACTIVE:-true}"
    echo ""
    
    # Step 1: Validate environment
    validate_environment "$SKIP_PUBLISH" "$SKIP_GITHUB_RELEASE"
    
    # Step 2: Version calculation
    step "Calculating new version..."
    local current_version
    current_version=$(get_current_version)
    info "Current version: $current_version"
    
    local new_version
    new_version=$(calculate_new_version "$current_version" "$VERSION_TYPE")
    info "New version: $new_version"
    
    # Confirm before proceeding
    if [[ "$INTERACTIVE" == "true" ]] && [[ "$DRY_RUN" != "true" ]]; then
        echo ""
        if ! confirm "Proceed with release $current_version â†’ $new_version?"; then
            warn "Release cancelled by user"
            exit 0
        fi
    fi
    echo ""
    
    # Step 3: Generate changelog
    step "Generating changelog..."
    local last_tag
    last_tag=$(get_last_version_tag)
    generate_changelog "$new_version" "$last_tag" "HEAD"
    echo ""
    
    # Step 4: Update version files
    update_version_files "$new_version"
    echo ""
    
    # Step 5: Run tests
    if [[ "$SKIP_TESTS" != "true" ]]; then
        run_tests
        echo ""
    else
        warn "Skipping tests (--skip-tests specified)"
        echo ""
    fi
    
    # Step 6: Build gem
    build_gem "$new_version"
    echo ""
    
    # Step 7: Commit and tag
    commit_and_tag "$new_version"
    echo ""
    
    # Step 8: Publish gem
    if [[ "$SKIP_PUBLISH" != "true" ]]; then
        publish_gem "$new_version"
        echo ""
    else
        warn "Skipping RubyGems publication (--skip-publish specified)"
        echo ""
    fi
    
    # Step 9: Create GitHub release
    if [[ "$SKIP_GITHUB_RELEASE" != "true" ]]; then
        create_github_release "$new_version"
        echo ""
    else
        warn "Skipping GitHub release (--no-github-release specified)"
        echo ""
    fi
    
    # Step 10: Push changes
    push_changes
    echo ""
    
    # Step 11: Cleanup
    cleanup_gem_files "$new_version"
    echo ""
    
    # Success summary
    print_header "âœ… Release Complete!"
    
    print_summary "Release $new_version" \
        "Version: $current_version â†’ $new_version" \
        "Type: $VERSION_TYPE bump" \
        "Tag: v$new_version" \
        "" \
        "ðŸ“¦ RubyGems: https://rubygems.org/gems/jekyll-theme-zer0/versions/$new_version" \
        "ðŸ·ï¸  GitHub: https://github.com/bamr87/zer0-mistakes/releases/tag/v$new_version" \
        "ðŸ“‚ Repository: https://github.com/bamr87/zer0-mistakes"
    
    success "Release workflow completed successfully!"
}

# Run main function
main "$@"
