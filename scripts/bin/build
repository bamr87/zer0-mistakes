#!/bin/bash

# Simplified build command for zer0-mistakes Jekyll theme
# Usage: ./scripts/build [options]
#
# Quick gem building without the full release workflow.

set -euo pipefail

# Get script and library directories
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

# Source required libraries
source "$LIB_DIR/common.sh"
source "$LIB_DIR/validation.sh"
source "$LIB_DIR/version.sh"
source "$LIB_DIR/gem.sh"

# Show usage
show_usage() {
    cat << EOF
ðŸ”¨ Simplified Build Command for zer0-mistakes

USAGE:
    ./scripts/bin/build [OPTIONS]

DESCRIPTION:
    Builds the Jekyll theme gem without running the full release workflow.
    Useful for testing gem packaging or preparing for manual publication.

OPTIONS:
    --dry-run     Preview build without creating files
    --verbose     Show detailed debug output
    --help, -h    Show this help message

EXAMPLES:
    ./scripts/bin/build                # Build gem with current version
    ./scripts/bin/build --dry-run      # Preview what would be built
    ./scripts/bin/build --verbose      # Build with debug output

ENVIRONMENT VARIABLES:
    DRY_RUN=true     Enable dry run mode
    VERBOSE=true     Enable debug output

OUTPUT:
    Creates: jekyll-theme-zer0-VERSION.gem in current directory

For full release workflow, use: ./scripts/release
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            export DRY_RUN=true
            shift
            ;;
        --verbose)
            export VERBOSE=true
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            error "Unknown option: $1 (use --help for usage)"
            ;;
    esac
done

# Main build workflow
main() {
    print_header "ðŸ”¨ Gem Build"
    
    # Step 1: Basic validation (no RubyGems auth needed for build)
    step "Validating environment..."
    validate_git_repo
    validate_required_files
    validate_gemspec
    success "Environment validated"
    echo ""
    
    # Step 2: Get current version
    step "Reading version..."
    local version
    version=$(get_current_version)
    info "Current version: $version"
    info "Gem file: jekyll-theme-zer0-${version}.gem"
    echo ""
    
    # Step 3: Build gem
    build_gem "$version"
    echo ""
    
    # Success summary
    if [[ "$DRY_RUN" != "true" ]]; then
        print_summary "Build Complete" \
            "âœ… Built: jekyll-theme-zer0-${version}.gem" \
            "" \
            "Next steps:" \
            "  â€¢ Test: gem install jekyll-theme-zer0-${version}.gem" \
            "  â€¢ Publish: gem push jekyll-theme-zer0-${version}.gem" \
            "  â€¢ Or use: ./scripts/release for full workflow"
    else
        info "Dry run complete - no files created"
    fi
    
    success "Build completed successfully!"
}

# Run main function
main "$@"
