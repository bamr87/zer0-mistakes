#!/usr/bin/env bash
# ==============================================================================
# Docker Publish Script - Local Docker Image Publishing
# ==============================================================================
#
# Publishes Docker images to Docker Hub from local environment.
# Uses credentials from .env file or environment variables.
#
# Usage:
#   ./scripts/docker-publish              # Build and push with auto-generated tag
#   ./scripts/docker-publish --tag v1.0.0 # Build and push with specific tag
#   ./scripts/docker-publish --latest     # Also update :latest tag
#   ./scripts/docker-publish --dry-run    # Show what would happen
#   ./scripts/docker-publish --build-only # Build but don't push
#
# ==============================================================================

set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

# Default values
DRY_RUN=false
BUILD_ONLY=false
UPDATE_LATEST=false
CUSTOM_TAG=""
PLATFORM="linux/amd64"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --build-only)
            BUILD_ONLY=true
            shift
            ;;
        --latest)
            UPDATE_LATEST=true
            shift
            ;;
        --tag)
            CUSTOM_TAG="$2"
            shift 2
            ;;
        --platform)
            PLATFORM="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --tag TAG       Use specific tag (default: auto-generated)"
            echo "  --latest        Also update :latest tag"
            echo "  --dry-run       Show what would happen without doing it"
            echo "  --build-only    Build image but don't push"
            echo "  --platform      Platform to build for (default: linux/amd64)"
            echo "  --help          Show this help message"
            echo ""
            echo "Environment variables (from .env or shell):"
            echo "  DOCKER_USERNAME  Docker Hub username"
            echo "  DOCKER_TOKEN     Docker Hub access token"
            echo "  DOCKER_IMAGE     Full image name (e.g., amrabdel/zer0-mistakes)"
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Load .env file if it exists
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    log_info "Loading environment from .env file..."
    set -a
    source "$PROJECT_ROOT/.env"
    set +a
fi

# Validate required variables
if [[ -z "${DOCKER_USERNAME:-}" ]]; then
    log_error "DOCKER_USERNAME is not set. Add it to .env or export it."
    exit 1
fi

if [[ -z "${DOCKER_IMAGE:-}" ]]; then
    log_error "DOCKER_IMAGE is not set. Add it to .env or export it."
    exit 1
fi

if [[ "$BUILD_ONLY" == "false" && -z "${DOCKER_TOKEN:-}" ]]; then
    log_error "DOCKER_TOKEN is not set. Add it to .env or export it."
    log_info "Get your token at: https://hub.docker.com/settings/security"
    exit 1
fi

# Generate tag if not provided
if [[ -z "$CUSTOM_TAG" ]]; then
    # Format: YYYYMMDD-HHMMSS-shortsha
    DATE_TAG=$(date +%Y%m%d-%H%M%S)
    SHORT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "local")
    IMAGE_TAG="${DATE_TAG}-${SHORT_SHA}"
else
    IMAGE_TAG="$CUSTOM_TAG"
fi

# Full image references
FULL_IMAGE="${DOCKER_IMAGE}:${IMAGE_TAG}"
LATEST_IMAGE="${DOCKER_IMAGE}:latest"

log_info "=============================================="
log_info "Docker Publish - Local"
log_info "=============================================="
log_info "Image:     ${DOCKER_IMAGE}"
log_info "Tag:       ${IMAGE_TAG}"
log_info "Platform:  ${PLATFORM}"
log_info "Username:  ${DOCKER_USERNAME}"
log_info "Dry run:   ${DRY_RUN}"
log_info "Build only: ${BUILD_ONLY}"
log_info "Update latest: ${UPDATE_LATEST}"
log_info "=============================================="

# Build the image
build_image() {
    log_info "Building Docker image..."
    
    local build_cmd="docker build \
        --platform ${PLATFORM} \
        --file docker/Dockerfile \
        --target dev-test \
        --tag ${FULL_IMAGE}"
    
    if [[ "$UPDATE_LATEST" == "true" ]]; then
        build_cmd="$build_cmd --tag ${LATEST_IMAGE}"
    fi
    
    build_cmd="$build_cmd ."
    
    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "[DRY RUN] Would execute: $build_cmd"
    else
        log_info "Executing: $build_cmd"
        cd "$PROJECT_ROOT"
        eval "$build_cmd"
        log_success "Image built: ${FULL_IMAGE}"
    fi
}

# Login to Docker Hub
docker_login() {
    log_info "Logging in to Docker Hub..."
    
    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "[DRY RUN] Would login to Docker Hub as ${DOCKER_USERNAME}"
    else
        echo "${DOCKER_TOKEN}" | docker login --username "${DOCKER_USERNAME}" --password-stdin
        log_success "Logged in to Docker Hub"
    fi
}

# Push the image
push_image() {
    log_info "Pushing image to Docker Hub..."
    
    if [[ "$DRY_RUN" == "true" ]]; then
        log_info "[DRY RUN] Would push: ${FULL_IMAGE}"
        if [[ "$UPDATE_LATEST" == "true" ]]; then
            log_info "[DRY RUN] Would push: ${LATEST_IMAGE}"
        fi
    else
        docker push "${FULL_IMAGE}"
        log_success "Pushed: ${FULL_IMAGE}"
        
        if [[ "$UPDATE_LATEST" == "true" ]]; then
            docker push "${LATEST_IMAGE}"
            log_success "Pushed: ${LATEST_IMAGE}"
        fi
    fi
}

# Main execution
main() {
    cd "$PROJECT_ROOT"
    
    # Verify Docker is running
    if ! docker info &>/dev/null; then
        log_error "Docker is not running. Please start Docker Desktop."
        exit 1
    fi
    
    # Build the image
    build_image
    
    # Stop here if build-only mode
    if [[ "$BUILD_ONLY" == "true" ]]; then
        log_success "Build complete (--build-only mode, not pushing)"
        exit 0
    fi
    
    # Login and push
    docker_login
    push_image
    
    # Summary
    echo ""
    log_success "=============================================="
    log_success "Docker Publish Complete!"
    log_success "=============================================="
    log_info "Image: ${FULL_IMAGE}"
    log_info "URL:   https://hub.docker.com/r/${DOCKER_IMAGE}/tags"
    if [[ "$UPDATE_LATEST" == "true" ]]; then
        log_info "Latest: ${LATEST_IMAGE}"
    fi
    echo ""
    log_info "To pull this image:"
    log_info "  docker pull ${FULL_IMAGE}"
}

main
