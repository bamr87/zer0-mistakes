#!/bin/bash

# =========================================================================
# Test Framework Configuration
# =========================================================================
# Central configuration for all test scripts in the zer0-mistakes theme.
# Source this file in test scripts: source "$(dirname "$0")/test.conf"
# =========================================================================

# -------------------------------------------------------------------------
# Test Environment
# -------------------------------------------------------------------------
export TEST_FRAMEWORK_VERSION="2.0.0"

# Timeouts (in seconds)
export TEST_TIMEOUT_DEFAULT=30
export TEST_TIMEOUT_BUILD=120
export TEST_TIMEOUT_DOCKER=180
export TEST_TIMEOUT_INSTALL=60
export TEST_TIMEOUT_VISUAL=90

# -------------------------------------------------------------------------
# Server Configuration
# -------------------------------------------------------------------------
export TEST_DEFAULT_PORT=4000
export TEST_FALLBACK_PORTS=(4001 4002 4003 4004)
export TEST_DEFAULT_HOST="localhost"
export TEST_DEFAULT_URL="http://${TEST_DEFAULT_HOST}:${TEST_DEFAULT_PORT}"

# Wait times for server startup
export TEST_SERVER_STARTUP_WAIT=10
export TEST_SERVER_POLL_INTERVAL=1

# -------------------------------------------------------------------------
# Test Directories
# -------------------------------------------------------------------------
# These are relative to repository root
export TEST_WORKSPACE_DIR="test/workspaces"
export TEST_FIXTURES_DIR="test/fixtures"
export TEST_OUTPUT_DIR="test/output"
export TEST_REPORTS_DIR="reports"
export TEST_LOGS_DIR="logs"

# -------------------------------------------------------------------------
# Installation Modes for Matrix Testing
# -------------------------------------------------------------------------
export TEST_INSTALL_MODES=("full" "minimal" "fork")

# -------------------------------------------------------------------------
# Skip Conditions
# -------------------------------------------------------------------------
# Set these to "true" to skip certain test categories
export SKIP_DOCKER_TESTS="${SKIP_DOCKER_TESTS:-false}"
export SKIP_VISUAL_TESTS="${SKIP_VISUAL_TESTS:-false}"
export SKIP_SLOW_TESTS="${SKIP_SLOW_TESTS:-false}"
export SKIP_NETWORK_TESTS="${SKIP_NETWORK_TESTS:-false}"

# -------------------------------------------------------------------------
# Test Output
# -------------------------------------------------------------------------
export TEST_VERBOSE="${TEST_VERBOSE:-false}"
export TEST_COLOR_OUTPUT="${TEST_COLOR_OUTPUT:-true}"
export TEST_JUNIT_OUTPUT="${TEST_JUNIT_OUTPUT:-false}"
export TEST_JUNIT_FILE="${TEST_JUNIT_FILE:-test-results.xml}"

# -------------------------------------------------------------------------
# Assertions Configuration
# -------------------------------------------------------------------------
# Number of retries for flaky assertions
export TEST_RETRY_COUNT=3
export TEST_RETRY_DELAY=2

# -------------------------------------------------------------------------
# Docker Configuration
# -------------------------------------------------------------------------
export TEST_DOCKER_IMAGE="jekyll/jekyll:latest"
export TEST_DOCKER_PLATFORM="linux/amd64"
export TEST_DOCKER_COMPOSE_FILE="docker-compose.yml"
export TEST_DOCKER_COMPOSE_TEST_FILE="docker-compose.test.yml"

# -------------------------------------------------------------------------
# Visual Testing (Playwright)
# -------------------------------------------------------------------------
export TEST_VISUAL_BROWSERS=("chromium" "firefox")
export TEST_VISUAL_VIEWPORTS=("1920x1080" "1366x768" "375x667")
export TEST_VISUAL_THRESHOLD=0.1

# -------------------------------------------------------------------------
# Theme Validation
# -------------------------------------------------------------------------
# Required directories for a valid theme installation
export TEST_REQUIRED_DIRS=(
    "_layouts"
    "_includes"
    "_sass"
    "assets/css"
    "assets/js"
)

# Required files for a valid theme installation
export TEST_REQUIRED_FILES=(
    "_config.yml"
    "Gemfile"
    "index.html"
)

# Required files for full installation
export TEST_FULL_REQUIRED_FILES=(
    "_config.yml"
    "_config_dev.yml"
    "Gemfile"
    "docker-compose.yml"
    "index.html"
    "404.html"
)

# Required files for minimal installation
export TEST_MINIMAL_REQUIRED_FILES=(
    "_config.yml"
    "Gemfile"
    "index.md"
    ".gitignore"
)

# Required files for fork installation
export TEST_FORK_REQUIRED_FILES=(
    "_config.yml"
    "Gemfile"
    "_layouts/default.html"
    "_includes/core/head.html"
)

# Files that should NOT exist after fork cleanup
export TEST_FORK_REMOVED_PATHS=(
    "pages/_posts/2024"
    "pages/_notebooks"
    "CNAME"
    "_data/content_statistics.yml"
    "assets/images/previews"
)

# -------------------------------------------------------------------------
# URLs for Testing
# -------------------------------------------------------------------------
export TEST_GITHUB_REPO="bamr87/zer0-mistakes"
export TEST_GITHUB_RAW_URL="https://raw.githubusercontent.com/${TEST_GITHUB_REPO}/main"
export TEST_GITHUB_PAGES_URL="https://bamr87.github.io/zer0-mistakes"

# -------------------------------------------------------------------------
# Helper Functions
# -------------------------------------------------------------------------

# Get the repository root directory
get_test_repo_root() {
    local test_dir="${1:-$(dirname "${BASH_SOURCE[0]}")}"
    cd "$test_dir/.." && pwd
}

# Create a unique test workspace
create_test_workspace() {
    local name="${1:-test}"
    local repo_root
    repo_root=$(get_test_repo_root)
    local workspace="$repo_root/$TEST_WORKSPACE_DIR/${name}_$(date +%s)"
    mkdir -p "$workspace"
    echo "$workspace"
}

# Clean up test workspaces
cleanup_test_workspaces() {
    local repo_root
    repo_root=$(get_test_repo_root)
    rm -rf "$repo_root/$TEST_WORKSPACE_DIR"
}

# Check if a test category should be skipped
should_skip_test() {
    local category="$1"
    case "$category" in
        docker)
            [[ "$SKIP_DOCKER_TESTS" == "true" ]]
            ;;
        visual)
            [[ "$SKIP_VISUAL_TESTS" == "true" ]]
            ;;
        slow)
            [[ "$SKIP_SLOW_TESTS" == "true" ]]
            ;;
        network)
            [[ "$SKIP_NETWORK_TESTS" == "true" ]]
            ;;
        *)
            return 1
            ;;
    esac
}

# Wait for a server to be ready
wait_for_server() {
    local url="${1:-$TEST_DEFAULT_URL}"
    local timeout="${2:-$TEST_SERVER_STARTUP_WAIT}"
    local elapsed=0
    
    while [[ $elapsed -lt $timeout ]]; do
        if curl -s -o /dev/null -w "%{http_code}" "$url" 2>/dev/null | grep -q "200\|301\|302"; then
            return 0
        fi
        sleep "$TEST_SERVER_POLL_INTERVAL"
        ((elapsed += TEST_SERVER_POLL_INTERVAL))
    done
    
    return 1
}

# Find an available port
find_available_port() {
    local port=$TEST_DEFAULT_PORT
    
    # Check default port first
    if ! lsof -i ":$port" &>/dev/null; then
        echo "$port"
        return 0
    fi
    
    # Try fallback ports
    for port in "${TEST_FALLBACK_PORTS[@]}"; do
        if ! lsof -i ":$port" &>/dev/null; then
            echo "$port"
            return 0
        fi
    done
    
    # Return random high port
    echo $((RANDOM % 1000 + 5000))
}

# Export helper functions
export -f get_test_repo_root create_test_workspace cleanup_test_workspaces
export -f should_skip_test wait_for_server find_available_port
