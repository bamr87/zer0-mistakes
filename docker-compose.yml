# ==============================================================================
# Docker Compose - Development
# ==============================================================================
# 
# Zero Version Pin Strategy - Development Environment
# 
# Philosophy:
#   - No version pins anywhere â†’ always use latest compatible versions
#   - Bundler + Docker Hub resolve latest compatible at build time
#   - Production gets exactly what passed TEST (via immutable image tags)
# 
# Usage:
#   docker compose up              # Start development server
#   docker compose up --build      # Rebuild with latest dependencies
#   docker compose exec jekyll bash  # Access container shell
# 
# For testing: docker compose -f docker-compose.yml -f docker-compose.test.yml up
# For production: See docker-compose.prod.yml (use immutable tags only!)
# ==============================================================================

services:
  jekyll:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: dev-test
    
    # Platform specification for Apple Silicon compatibility
    platform: linux/amd64
    
    # Run bundle install first since volume mount overwrites container's /site
    # Also configure git safe.directory to avoid ownership warnings in CI
    command: ["sh", "-c", "git config --global --add safe.directory /site 2>/dev/null || true && bundle install --jobs 4 --retry 3 && bundle exec jekyll serve --watch --force_polling --config '_config.yml,_config_dev.yml' --host 0.0.0.0 --port 4000 --livereload"]
    
    volumes:
      - .:/site
      # Named volume for bundle cache (faster rebuilds)
      - bundle_cache:/usr/local/bundle
    
    ports:
      - "4000:4000"
      - "35729:35729"  # LiveReload port
    
    working_dir: /site
    
    environment:
      - JEKYLL_ENV=development
      - BUNDLE_PATH=/usr/local/bundle
      # Repository info for jekyll-github-metadata gem
      - PAGES_REPO_NWO=bamr87/zer0-mistakes
    
    # Enable TTY for interactive commands
    stdin_open: true
    tty: true

volumes:
  bundle_cache:
    driver: local

