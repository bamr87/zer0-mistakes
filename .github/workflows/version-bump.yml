name: Version Bump

permissions:
  contents: read

concurrency:
  group: version-bump-main
  cancel-in-progress: false

# Unified version bump workflow supporting both manual and automatic triggers
# - Manual: Use workflow_dispatch to select version type
# - Automatic: Analyzes commits on push to main to determine version bump

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'CHANGELOG.md'
      - 'lib/jekyll-theme-zer0/version.rb'
      - 'package.json'
      - '.github/workflows/**'
      - 'README.md'
      - 'docs/**'
      - 'release_notes.md'
      - '*.gem'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - auto  # Analyze commits to determine bump type
      skip_tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Preview changes without committing'
        required: false
        default: false
        type: boolean

env:
  RUBY_VERSION: '3.2'
  # Required for jekyll-github-metadata gem during CI builds
  # Uses repository variable if set, otherwise falls back to github.repository
  PAGES_REPO_NWO: ${{ vars.PAGES_REPO_NWO || github.repository }}

defaults:
  run:
    shell: bash

jobs:
  # Analyze commits to determine version bump type
  analyze:
    name: Analyze Changes
    runs-on: ubuntu-latest
    # Skip if commit is from GitHub Actions (prevents infinite loops)
    if: |
      !contains(github.event.head_commit.message, 'chore: bump version') && 
      !contains(github.event.head_commit.author.name, 'github-actions')
    outputs:
      bump_type: ${{ steps.determine.outputs.bump_type }}
      commit_range: ${{ steps.determine.outputs.commit_range }}
      commit_count: ${{ steps.determine.outputs.commit_count }}
      should_release: ${{ steps.determine.outputs.should_release }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Determine Version Bump Type
      id: determine
      run: |
        # For manual triggers, use the selected version type
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          SELECTED="${{ inputs.version_type }}"
          
          if [[ "$SELECTED" != "auto" ]]; then
            echo "bump_type=$SELECTED" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "commit_count=manual" >> $GITHUB_OUTPUT
            echo "commit_range=manual" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Manual version bump: $SELECTED"
            exit 0
          fi
        fi
        
        # Analyze commits for automatic or 'auto' selection
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          echo "No previous tags found, analyzing all commits"
          COMMIT_RANGE="$(git rev-list --max-parents=0 HEAD)..HEAD"
        else
          echo "Analyzing commits since: $LAST_TAG"
          COMMIT_RANGE="${LAST_TAG}..HEAD"
        fi
        
        echo "commit_range=$COMMIT_RANGE" >> $GITHUB_OUTPUT
        
        # Count commits
        COMMIT_COUNT=$(git rev-list --count $COMMIT_RANGE 2>/dev/null || echo "0")
        echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
        
        if [[ "$COMMIT_COUNT" == "0" ]]; then
          echo "bump_type=none" >> $GITHUB_OUTPUT
          echo "should_release=false" >> $GITHUB_OUTPUT
          echo "ðŸš« No new commits to release"
          exit 0
        fi
        
        # Analyze commit messages
        chmod +x ./scripts/analyze-commits.sh
        BUMP_TYPE=$(./scripts/analyze-commits.sh "$COMMIT_RANGE" 2>/dev/null || echo "patch")
        
        echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
        echo "should_release=true" >> $GITHUB_OUTPUT
        
        echo "ðŸ“‹ Analysis Results:"
        echo "  - Commit range: $COMMIT_RANGE"
        echo "  - Commits analyzed: $COMMIT_COUNT"
        echo "  - Recommended bump: $BUMP_TYPE"

  # Main version bump job
  version-bump:
    name: Bump Version
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should_release == 'true' && needs.analyze.outputs.bump_type != 'none'
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      tag: ${{ steps.bump.outputs.tag }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git Environment
      uses: ./.github/actions/configure-git
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Ruby Environment
      uses: ./.github/actions/setup-ruby
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        install-system-deps: true
        # Disable bundler cache for version bump - we need to modify Gemfile.lock
        bundler-cache: false

    - name: Run Pre-bump Validation
      if: ${{ !inputs.skip_tests }}
      uses: ./.github/actions/test-suite
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        verbose: true
        suites: 'core'
        skip-docker: true

    - name: Get Current Version
      id: current
      run: |
        CURRENT=$(ruby -e "require './lib/jekyll-theme-zer0/version'; puts JekyllThemeZer0::VERSION")
        echo "version=$CURRENT" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Current version: $CURRENT"

    - name: Bump Version
      id: bump
      run: |
        BUMP_TYPE="${{ needs.analyze.outputs.bump_type }}"
        CURRENT="${{ steps.current.outputs.version }}"
        DRY_RUN="${{ inputs.dry_run || 'false' }}"
        
        # Parse current version
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
        
        # Calculate new version
        case "$BUMP_TYPE" in
          major)
            NEW_VERSION="$((MAJOR + 1)).0.0"
            ;;
          minor)
            NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
            ;;
          patch|*)
            NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
            ;;
        esac
        
        echo "ðŸ“ˆ Version bump: $CURRENT â†’ $NEW_VERSION ($BUMP_TYPE)"
        
        if [[ "$DRY_RUN" == "true" ]]; then
          echo "ðŸ” DRY RUN - no changes will be made"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Update version in version.rb
        sed -i "s/VERSION = \".*\"/VERSION = \"$NEW_VERSION\"/" lib/jekyll-theme-zer0/version.rb
        
        # Update version in package.json if it exists
        if [[ -f "package.json" ]]; then
          sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" package.json
        fi
        
        # Update gemspec version if needed
        if [[ -f "jekyll-theme-zer0.gemspec" ]]; then
          # Gemspec typically reads from version.rb, so no change needed
          echo "Gemspec uses version.rb - no direct update needed"
        fi
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "âœ… Version files updated to $NEW_VERSION"

    - name: Update Gemfile.lock
      if: ${{ inputs.dry_run != true }}
      run: |
        NEW_VERSION="${{ steps.bump.outputs.new_version }}"
        
        echo "ðŸ“¦ Regenerating Gemfile.lock for version $NEW_VERSION..."
        
        # Ensure bundler is not in frozen/deployment mode
        bundle config set --local frozen false
        bundle config unset deployment 2>/dev/null || true
        
        # Run bundle install to regenerate lockfile with new gemspec version
        bundle install --jobs 4 --retry 3
        
        # Verify the lockfile was updated correctly
        if grep -q "jekyll-theme-zer0 ($NEW_VERSION)" Gemfile.lock; then
          echo "âœ… Gemfile.lock updated and verified for version $NEW_VERSION"
        else
          echo "âš ï¸ Warning: Gemfile.lock may not reflect new version"
          echo "Current gem version in lockfile:"
          grep "jekyll-theme-zer0" Gemfile.lock | head -3 || true
        fi

    - name: Update Changelog
      if: ${{ inputs.dry_run != true }}
      run: |
        NEW_VERSION="${{ steps.bump.outputs.new_version }}"
        BUMP_TYPE="${{ needs.analyze.outputs.bump_type }}"
        TODAY=$(date +%Y-%m-%d)
        
        # Generate changelog entry
        TEMP_FILE=$(mktemp)
        
        cat > "$TEMP_FILE" << EOF
        ## [$NEW_VERSION] - $TODAY

        ### Changed
        - Version bump: $BUMP_TYPE release
        EOF
        
        # Try to add commit-based changes if analyze script exists
        if [[ -f "./scripts/analyze-commits.sh" && "${{ needs.analyze.outputs.commit_range }}" != "manual" ]]; then
          # Get commit summaries
          COMMITS=$(git log --oneline ${{ needs.analyze.outputs.commit_range }} 2>/dev/null | head -20)
          if [[ -n "$COMMITS" ]]; then
            echo "" >> "$TEMP_FILE"
            echo "### Commits in this release" >> "$TEMP_FILE"
            echo "$COMMITS" | while read line; do
              echo "- $line" >> "$TEMP_FILE"
            done
          fi
        fi
        
        echo "" >> "$TEMP_FILE"
        
        # Prepend to CHANGELOG.md
        if [[ -f "CHANGELOG.md" ]]; then
          # Insert after the first header line
          head -1 CHANGELOG.md > CHANGELOG.new
          echo "" >> CHANGELOG.new
          cat "$TEMP_FILE" >> CHANGELOG.new
          tail -n +2 CHANGELOG.md >> CHANGELOG.new
          mv CHANGELOG.new CHANGELOG.md
        else
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          cat "$TEMP_FILE" >> CHANGELOG.md
        fi
        
        rm -f "$TEMP_FILE"
        echo "âœ… Changelog updated"

    - name: Commit and Push Changes
      if: ${{ inputs.dry_run != true }}
      run: |
        NEW_VERSION="${{ steps.bump.outputs.new_version }}"
        BUMP_TYPE="${{ needs.analyze.outputs.bump_type }}"
        
        git add lib/jekyll-theme-zer0/version.rb package.json CHANGELOG.md Gemfile.lock 2>/dev/null || true
        git add -A
        
        git commit -m "chore: bump version to $NEW_VERSION

        - Version bump type: $BUMP_TYPE
        - Updated version files, gemfile.lock, and changelog
        - Automated by GitHub Actions
        
        [skip ci]" || echo "Nothing to commit"
        
        git push origin main
        echo "âœ… Changes pushed to main"

    - name: Create and Push Tag
      if: ${{ inputs.dry_run != true }}
      run: |
        TAG="${{ steps.bump.outputs.tag }}"
        
        git tag "$TAG"
        git push origin "$TAG"
        echo "âœ… Tag $TAG created and pushed"
        echo ""
        echo "ðŸš€ This tag push will trigger the release workflow automatically."

    - name: Version Bump Summary
      run: |
        echo "## ðŸš€ Version Bump Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Type** | ${{ needs.analyze.outputs.bump_type }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Previous** | ${{ steps.current.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **New Version** | ${{ steps.bump.outputs.new_version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Tag** | ${{ steps.bump.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Dry Run** | ${{ inputs.dry_run || 'false' }} |" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.analyze.outputs.commit_count }}" != "manual" ]]; then
          echo "| **Commits Analyzed** | ${{ needs.analyze.outputs.commit_count }} |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ inputs.dry_run }}" != "true" ]]; then
          echo "âœ… Tag push will trigger the release workflow to publish to RubyGems and create GitHub release." >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ” Dry run complete - no changes were made." >> $GITHUB_STEP_SUMMARY
        fi

  # Skip notification when no release needed
  skip-notification:
    name: No Release Needed
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should_release != 'true' || needs.analyze.outputs.bump_type == 'none'

    steps:
    - name: Skip Summary
      run: |
        echo "## ðŸš« No Version Bump Needed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "No releasable changes detected in commit analysis." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "To force a release, use the manual workflow dispatch with a specific version type." >> $GITHUB_STEP_SUMMARY
