name: Comprehensive CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run full tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test scope'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'fast'        # Quick feedback tests
          - 'standard'    # Full test suite
          - 'comprehensive' # All tests + performance
      fix_markdown:
        description: 'Auto-fix markdown formatting'
        required: false
        default: false
        type: boolean

# ==============================================================================
# Note: This workflow uses explicit Ruby versions for testing compatibility.
# For the zero-pin strategy (latest everything), see test-latest.yml
# ==============================================================================
env:
  # These are used for backwards compatibility testing
  # The test-latest.yml workflow uses actual latest versions
  RUBY_VERSION: '3.2'
  NODE_VERSION: '18'

defaults:
  run:
    shell: bash

jobs:
  # Fast feedback job for quick validation
  fast-checks:
    name: Fast Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Ruby Environment
        uses: ./.github/actions/setup-ruby
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          install-system-deps: false

      - name: Quick Syntax Check
        run: ruby -c lib/jekyll-theme-zer0/version.rb

      - name: Validate Gemspec
        run: |
          ruby -e "
            spec = Gem::Specification.load('jekyll-theme-zer0.gemspec')
            puts 'âœ… Gemspec valid: #{spec.name} v#{spec.version}'
          "

  # Quality control checks
  quality-checks:
    name: Quality Control
    runs-on: ubuntu-latest
    needs: fast-checks
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Quality Checks
        uses: ./.github/actions/quality-checks
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          check-markdown: true
          fix-formatting: ${{ inputs.fix_markdown }}

  # Comprehensive testing across Ruby versions
  test:
    name: Test Suite (Ruby ${{ matrix.ruby }})
    runs-on: ubuntu-latest
    needs: [fast-checks, quality-checks]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        ruby: ['3.2', '3.3']
        include:
          - ruby: '3.2'
            coverage: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Test Suite
        uses: ./.github/actions/test-suite
        with:
          ruby-version: ${{ matrix.ruby }}
          verbose: true
          suites: core,quality
          skip-docker: true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-ruby-${{ matrix.ruby }}
          path: test/results/
          retention-days: 7

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: matrix.coverage
        with:
          name: coverage-ruby-${{ matrix.ruby }}
          path: test/coverage/
          retention-days: 7

  # NOTE: Code quality & documentation checks are handled by the quality-checks job above
  # The duplicate 'quality' job has been removed to avoid redundancy
  # Build validation
  build:
    name: Build & Validate
    runs-on: ubuntu-latest
    needs: [test, quality-checks]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby environment
        uses: ./.github/actions/setup-ruby
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          install-system-deps: true

      - name: Build gem
        run: |
          chmod +x ./scripts/build
          ./scripts/build

      - name: Validate gem
        run: |
          # Get version from Ruby file (most reliable source)
          VERSION=$(ruby -e "require './lib/jekyll-theme-zer0/version'; puts JekyllThemeZer0::VERSION")
          GEM_FILE="jekyll-theme-zer0-${VERSION}.gem"

          if [ -f "$GEM_FILE" ]; then
            echo "âœ… Gem built successfully: $GEM_FILE"
            gem spec "$GEM_FILE" | grep -E "(name|version|files)" | head -5
          else
            echo "âŒ Gem file not found: $GEM_FILE"
            ls -la *.gem 2>/dev/null || echo "No .gem files found"
            exit 1
          fi

      - name: Test gem installation
        run: |
          # Install dependencies first (Jekyll is required by the gem)
          bundle install --quiet
          # Now install our gem locally (dependencies already satisfied)
          gem install ./jekyll-theme-zer0-*.gem --local --no-document --ignore-dependencies
          echo "âœ… Gem installs successfully"

  # Performance testing (conditional)
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'schedule' || inputs.test_scope == 'comprehensive'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby environment
        uses: ./.github/actions/setup-ruby
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          install-system-deps: false

      - name: Run Jekyll build performance test
        run: |
          echo "## Performance Results" >> $GITHUB_STEP_SUMMARY
          echo "### Build Performance" >> $GITHUB_STEP_SUMMARY

          START_TIME=$(date +%s)
          bundle exec jekyll build --profile 2>&1 | tee build-profile.txt
          END_TIME=$(date +%s)

          BUILD_TIME=$((END_TIME - START_TIME))
          echo "- Build completed in: ${BUILD_TIME}s" >> $GITHUB_STEP_SUMMARY

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: build-profile.txt
          retention-days: 30

  # Integration testing with Docker
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || inputs.test_scope == 'comprehensive')
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Jekyll in Docker
        run: |
          docker compose up -d
          timeout 60 bash -c 'until curl -s http://localhost:4000 > /dev/null; do sleep 2; done' || true

      - name: Test site accessibility
        run: |
          if curl -f http://localhost:4000 > /dev/null 2>&1; then
            echo "âœ… Site is accessible"
          else
            echo "âŒ Site is not accessible"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: docker compose down || true

  # Final status report
  summary:
    name: CI Pipeline Summary
    runs-on: ubuntu-latest
    needs: [fast-checks, quality-checks, test, build, performance, integration]
    if: always()
    steps:
      - name: Generate comprehensive summary
        run: |
          echo "## ðŸ—ï¸ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Check | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Fast Checks | ${{ needs.fast-checks.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Quality Checks | ${{ needs.quality-checks.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build | ${{ needs.build.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Performance | ${{ needs.performance.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Integration | ${{ needs.integration.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all required jobs passed
          if [[ "${{ needs.fast-checks.result }}" == "success" && 
                "${{ needs.test.result }}" == "success" && 
                "${{ needs.quality-checks.result }}" == "success" && 
                "${{ needs.build.result }}" == "success" ]]; then
            echo "## âœ… **Pipeline Status: SUCCESS**" >> $GITHUB_STEP_SUMMARY
            echo "All critical checks passed! The code is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ **Pipeline Status: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Some critical checks failed. Please review the results above." >> $GITHUB_STEP_SUMMARY
            
            # List failed jobs
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Jobs:" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.fast-checks.result }}" != "success" ]] && echo "- ðŸš€ Fast Checks" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test.result }}" != "success" ]] && echo "- ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.quality-checks.result }}" != "success" ]] && echo "- ðŸ“‹ Quality Checks" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.build.result }}" != "success" ]] && echo "- ðŸ”¨ Build" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.performance.result }}" == "failure" ]] && echo "- âš¡ Performance (non-critical)" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.integration.result }}" == "failure" ]] && echo "- ðŸ”— Integration (non-critical)" >> $GITHUB_STEP_SUMMARY
            
            exit 1
          fi
