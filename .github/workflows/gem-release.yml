name: Release Gem to RubyGems

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to RubyGems'
        required: false
        default: false
        type: boolean

env:
  RUBY_VERSION: '3.0'

jobs:
  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Ruby environment
      uses: ./.github/actions/setup-ruby
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        install-system-deps: true

    - name: Run tests
      run: ./test/test_runner.sh --verbose

  build:
    name: Build Gem
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Setup Ruby environment
      uses: ./.github/actions/setup-ruby
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        install-system-deps: true

    - name: Build gem
      run: ./scripts/build.sh

    - name: Upload gem artifact
      uses: actions/upload-artifact@v4
      with:
        name: gem-${{ github.ref_name }}
        path: jekyll-theme-zer0-*.gem
        retention-days: 30

  publish:
    name: Publish to RubyGems
    runs-on: ubuntu-latest
    needs: [test, build]
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish)
    environment: production

    steps:
    - uses: actions/checkout@v4

    - name: Setup Ruby environment
      uses: ./.github/actions/setup-ruby
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        install-system-deps: false

    - name: Download gem artifact
      uses: actions/download-artifact@v4
      with:
        name: gem-${{ github.ref_name }}

    - name: Configure RubyGems credentials
      run: |
        mkdir -p ~/.gem
        cat > ~/.gem/credentials << EOF
        ---
        :rubygems_api_key: ${{ secrets.RUBYGEMS_API_KEY }}
        EOF
        chmod 600 ~/.gem/credentials

    - name: Publish gem
      run: |
        GEM_FILE=$(ls jekyll-theme-zer0-*.gem)
        gem push "$GEM_FILE"
        echo "âœ… Published $GEM_FILE to RubyGems"

    - name: Summary
      run: |
        echo "## ðŸ“¦ Gem Published Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **RubyGems**: https://rubygems.org/gems/jekyll-theme-zer0" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "The GitHub release will be created by the github-release.yml workflow." >> $GITHUB_STEP_SUMMARY
