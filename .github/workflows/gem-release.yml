name: Release Gem to RubyGems

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to RubyGems'
        required: false
        default: false
        type: boolean

env:
  RUBY_VERSION: '3.2'

defaults:
  run:
    shell: bash

jobs:
  # Pre-release validation
  test:
    name: Pre-release Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Run Test Suite
      uses: ./.github/actions/test-suite
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        verbose: true

  # Build and prepare release assets
  build:
    name: Build Release Assets
    runs-on: ubuntu-latest
    needs: test
    outputs:
      gem-version: ${{ steps.prepare.outputs.gem-version }}
      gem-file: ${{ steps.prepare.outputs.gem-file }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Prepare Release Assets
      id: prepare
      uses: ./.github/actions/prepare-release
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        validate-assets: true

    - name: Upload Gem Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gem-${{ github.ref_name }}
        path: build/jekyll-theme-zer0-*.gem
        retention-days: 30

  # Publish to RubyGems
  publish:
    name: Publish to RubyGems
    runs-on: ubuntu-latest
    needs: [test, build]
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish)
    environment: production

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Ruby Environment
      uses: ./.github/actions/setup-ruby
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        install-system-deps: false

    - name: Download Gem Artifact
      uses: actions/download-artifact@v4
      with:
        name: gem-${{ github.ref_name }}

    - name: Configure RubyGems Credentials
      run: |
        mkdir -p ~/.gem
        cat > ~/.gem/credentials << EOF
        ---
        :rubygems_api_key: ${{ secrets.RUBYGEMS_API_KEY }}
        EOF
        chmod 600 ~/.gem/credentials

    - name: Publish Gem
      run: |
        GEM_FILE=$(ls jekyll-theme-zer0-*.gem)
        gem push "$GEM_FILE"
        echo "âœ… Published $GEM_FILE to RubyGems"

    - name: Publish Summary
      run: |
        echo "## ðŸ“¦ Gem Published Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **RubyGems**: https://rubygems.org/gems/jekyll-theme-zer0" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "The GitHub release will be created by the github-release.yml workflow." >> $GITHUB_STEP_SUMMARY
